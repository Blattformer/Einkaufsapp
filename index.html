<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Familien-Planer</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">

    <style>
        * { box-sizing: border-box; }

        :root {
            --bg: #121212; --card-bg: #1e1e1e; --text-main: #e0e0e0;
            --text-muted: #a0a0a0; --primary: #00d26a; --danger: #ff5252;
            --secondary: #4dabf7; --border: #333333; --input-bg: #2c2c2c;
            --sort-btn: #f39c12;
            --nav-bg: #1a1a1a;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 10px; padding-bottom: 140px; }
        
        .view-section { display: none; }
        .view-section.active { display: block; }

        .header { 
            display: flex; gap: 10px; align-items: center; margin-bottom: 20px; 
            background: var(--card-bg); padding: 10px; border-radius: 12px; border: 1px solid var(--border);
        }
        
        .list-select-wrapper { flex-grow: 1; position: relative; }
        select { 
            width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); 
            background: var(--input-bg); color: var(--text-main); font-size: 1rem; outline: none; appearance: none;
        }
        
        .btn-header {
            background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main);
            width: 40px; height: 40px; border-radius: 8px; font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-header.add { color: var(--primary); font-weight: bold; }
        .btn-header.del { color: var(--danger); }
        .btn-header.sort { color: var(--text-muted); transition: color 0.3s, border-color 0.3s; }
        .btn-header.sort.active { color: var(--sort-btn); border-color: var(--sort-btn); background: rgba(243, 156, 18, 0.1); }

        #shoppingList, #recipeList { display: flex; flex-direction: column; gap: 10px; }
        
        .item-row { 
            background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; 
            display: flex; align-items: center; padding: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.2s;
        }

        .recipe-card {
            background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; 
            padding: 0; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .recipe-header {
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            background: #252525; cursor: pointer;
        }
        .recipe-title { font-weight: bold; font-size: 1.1rem; flex-grow: 1; }
        .recipe-details {
            display: none; padding: 15px; background: var(--card-bg);
            border-top: 1px solid var(--border);
        }
        /* Wenn Karte offen ist */
        .recipe-card.open .recipe-details { display: block; }
        
        .recipe-ingredients { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .ingredient-row {
            display: flex; justify-content: space-between; padding: 8px; 
            background: var(--input-bg); border-radius: 6px; font-size: 0.95rem;
        }
        .btn-add-recipe-to-list {
            width: 100%; padding: 12px; background: var(--primary); color: #000; font-weight: bold;
            border: none; border-radius: 8px; margin-top: 10px; cursor: pointer;
        }

        .btn-star { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #444; margin-right: 8px; padding: 0; transition: color 0.2s; flex-shrink: 0; }
        .btn-star.is-fav { color: #f1c40f; }
        
        .qty-display { font-weight: bold; color: var(--secondary); margin-right: 8px; min-width: 35px; font-size: 0.9rem; flex-shrink: 0; }
        .name-text { flex-grow: 1; font-size: 1.1rem; color: var(--text-main); word-break: break-word; }
        .qty-input { width: 50px; border: 1px solid var(--border); border-radius: 6px; padding: 8px 4px; margin-right: 5px; text-align: center; background: var(--input-bg); color: var(--text-main); flex-shrink: 0; }
        .btn-delete { color: var(--danger); font-size: 1.8rem; border: none; background: none; cursor: pointer; padding: 0 5px; opacity: 0.8; flex-shrink: 0; }
        
        .sort-controls { display: none; gap: 4px; margin-left: 5px; }
        .btn-arrow {
            background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main);
            width: 32px; height: 32px; border-radius: 6px; font-size: 0.9rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; padding: 0;
        }
        .btn-arrow.extreme { font-size: 1.1rem; font-weight: bold; background: #252525; color: var(--sort-btn); border-color: #444; }
        
        body.sorting-active .btn-delete, body.sorting-active .qty-input, body.sorting-active .btn-star { display: none; }
        body.sorting-active .sort-controls { display: flex; }
        body.sorting-active .item-row { border-color: var(--sort-btn); padding-right: 5px; }
        
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 60px;
            background: var(--nav-bg); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center; z-index: 2500;
        }
        .nav-item {
            flex: 1; text-align: center; padding: 10px; color: var(--text-muted); 
            font-size: 0.9rem; cursor: pointer;
        }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { display: block; font-size: 1.5rem; margin-bottom: 2px; }

        .add-area {
            position: fixed; bottom: 60px; left: 0; right: 0;
            background: var(--card-bg); 
            padding: 15px 15px calc(15px + env(safe-area-inset-bottom)) 15px;
            border-top: 1px solid var(--border);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            display: flex; gap: 10px; align-items: center; z-index: 2000;
        }
        body.sorting-active .add-area { display: none; }

        #newItemName, #newRecipeName, #newIngredientName { 
            flex-grow: 1; padding: 12px; border: 1px solid var(--border); border-radius: 10px; 
            font-size: 1rem; outline: none; background: var(--input-bg); color: var(--text-main); 
        }
        
        .panel-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 2999;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .panel-overlay.visible { opacity: 1; pointer-events: auto; }

        .fav-panel {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #252525; border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5); transform: translateY(110%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 3000;
            max-height: 80vh; display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom);
        }
        .fav-panel.visible { transform: translateY(0); }

        .panel-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .panel-title { font-size: 1.1rem; font-weight: bold; color: var(--text-main); }
        .btn-close-panel { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }

        .panel-scroll-content { overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }

        .fav-row {
            padding: 12px 15px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border);
            color: var(--text-main); cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .fav-row.selected { border-color: var(--primary); background: rgba(0, 210, 106, 0.1); color: #fff; }
        .check-icon { font-weight: bold; color: var(--primary); opacity: 0; transform: scale(0.5); transition: all 0.2s; }
        .fav-row.selected .check-icon { opacity: 1; transform: scale(1.2); }

        .panel-footer { padding: 15px; border-top: 1px solid var(--border); background: #252525; }
        .btn-confirm-favs {
            width: 100%; padding: 14px; border-radius: 10px; background: var(--primary); color: #000;
            border: none; font-weight: bold; font-size: 1rem; opacity: 0.5; pointer-events: none; transition: opacity 0.2s;
        }
        .btn-confirm-favs.ready { opacity: 1; pointer-events: auto; }
        
        .btn-add { background: var(--primary); color: #000; border: none; padding: 12px 20px; border-radius: 10px; font-weight: bold; font-size: 1rem; white-space: nowrap; }

    </style>
</head>
<body>

<div id="view-shopping" class="view-section active">
    <div class="header">
        <div class="list-select-wrapper">
            <select id="listSelect" onchange="switchList()"></select>
        </div>
        <button class="btn-header sort" onclick="toggleSortMode()" title="Sortieren">‚áÖ</button>
        <button class="btn-header add" onclick="createNewList()">+</button>
        <button class="btn-header del" onclick="deleteCurrentList()">üóë</button>
    </div>

    <h3 id="currentTitle" style="margin: 0 0 15px 5px; color: var(--text-muted); font-weight: normal; font-size: 0.9rem;">Lade...</h3>
    <div id="shoppingList"></div>
    
    <div class="add-area">
        <button class="btn-star" style="font-size: 1.8rem; color: #f1c40f;" onclick="openFavPanel('list')">‚òÖ</button>
        <input type="text" id="newItemName" placeholder="Artikel hinzuf√ºgen..." enterkeyhint="go" onkeypress="if(event.key==='Enter') addItem()">
    </div>
</div>

<div id="view-recipes" class="view-section">
    <div class="header">
        <span style="font-weight:bold; font-size:1.2rem; flex-grow:1;">Meine Rezepte</span>
    </div>
    
    <div id="recipeList"></div>

    <div class="add-area">
        <input type="text" id="newRecipeName" placeholder="Neues Rezept anlegen..." enterkeyhint="go" onkeypress="if(event.key==='Enter') addRecipe()">
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchView('shopping', this)">
        <span class="nav-icon">üõí</span> Einkauf
    </div>
    <div class="nav-item" onclick="switchView('recipes', this)">
        <span class="nav-icon">üç≥</span> Rezepte
    </div>
</nav>


<div class="panel-overlay" id="favOverlay" onclick="closePanels()"></div>

<div class="fav-panel" id="favPanel">
    <div class="panel-header">
        <span class="panel-title">Favoriten w√§hlen</span>
        <button class="btn-close-panel" onclick="closePanels()">√ó</button>
    </div>
    <div class="panel-scroll-content" id="favListContainer"></div>
    <div class="panel-footer">
        <button id="btnConfirmFavs" class="btn-confirm-favs" onclick="addSelectedFavs()">Hinzuf√ºgen</button>
    </div>
</div>

<div class="fav-panel" id="recipeAddPanel">
    <div class="panel-header">
        <span class="panel-title">Was brauchst du?</span>
        <button class="btn-close-panel" onclick="closePanels()">√ó</button>
    </div>
    <div class="panel-scroll-content" id="recipeAddContainer"></div>
    <div class="panel-footer">
        <button class="btn-confirm-favs ready" style="opacity:1; pointer-events:auto;" onclick="confirmAddRecipe()">√úbertragen</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, writeBatch, query, where, orderBy, serverTimestamp, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD5m0MvysOWVb53pRpqCXaMnofUTBjNgDo",
        authDomain: "einkaufsliste-2-d392b.firebaseapp.com",
        projectId: "einkaufsliste-2-d392b",
        storageBucket: "einkaufsliste-2-d392b.firebasestorage.app",
        messagingSenderId: "883591306736",
        appId: "1:883591306736:web:5c9754c6ab03157b1bd135",
        measurementId: "G-WPG6YSQGNT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentList = localStorage.getItem('lastActiveList') || "Wocheneinkauf";
    let localItems = []; 
    let favorites = []; 
    
    let selectedFavs = []; 
    let targetMode = 'list';
    let targetRecipeId = null;
    let transferIngredients = []; 

    // WICHTIG: Hier merken wir uns, welches Rezept offen ist!
    let openRecipeId = null; 

    let listUnsubscribe = null;
    let itemsUnsubscribe = null;
    let favsUnsubscribe = null;
    let recipesUnsubscribe = null;
    let isSortMode = false;

    window.switchView = function(viewName, navEl) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewName).classList.add('active');
        if(navEl) navEl.classList.add('active');
        closePanels();
    }

    // --- REZEPT LOGIK (Mit Ged√§chtnis) ---
    
    function subscribeToRecipes() {
        const q = query(collection(db, "recipes"), orderBy("name", "asc"));
        recipesUnsubscribe = onSnapshot(q, (snapshot) => {
            const container = document.getElementById('recipeList');
            container.innerHTML = '';
            
            if (snapshot.empty) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#555;">Noch keine Rezepte.</div>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const recipeId = doc.id;
                const ingredients = data.ingredients || [];

                const card = document.createElement('div');
                card.className = 'recipe-card';
                card.id = `recipe-${recipeId}`;
                
                // HIER: Pr√ºfen ob es offen sein soll
                if(recipeId === openRecipeId) {
                    card.classList.add('open');
                }
                
                let ingredientsHtml = '';
                ingredients.forEach(ing => {
                    ingredientsHtml += `
                        <div class="ingredient-row">
                            <span>‚Ä¢ ${ing}</span>
                            <span style="color:var(--danger); cursor:pointer;" onclick="deleteIngredient('${recipeId}', '${ing}')">√ó</span>
                        </div>`;
                });

                card.innerHTML = `
                    <div class="recipe-header" onclick="toggleRecipe('${recipeId}')">
                        <span class="recipe-title">${data.name}</span>
                        <button class="btn-delete" onclick="event.stopPropagation(); deleteRecipe('${recipeId}')">üóë</button>
                    </div>
                    <div class="recipe-details">
                        <div class="recipe-ingredients">${ingredientsHtml}</div>
                        
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <button class="btn-star" style="color:#f1c40f;" onclick="openFavPanel('recipe', '${recipeId}')">‚òÖ</button>
                            <input type="text" class="recipe-ing-input" placeholder="Zutat..." 
                                   onkeypress="if(event.key==='Enter') addIngredient('${recipeId}', this.value)">
                            <button class="btn-add" onclick="addIngredientTrigger('${recipeId}')">+</button>
                        </div>

                        <button class="btn-add-recipe-to-list" onclick="openRecipeAddPanel('${recipeId}')">Auf Einkaufsliste</button>
                    </div>
                `;
                container.appendChild(card);
            });
        });
    }

    // Toggle Funktion angepasst: Merkt sich den Status
    window.toggleRecipe = function(id) {
        const card = document.getElementById(`recipe-${id}`);
        
        // Andere schlie√üen
        document.querySelectorAll('.recipe-card').forEach(c => {
            if(c.id !== `recipe-${id}`) c.classList.remove('open');
        });
        
        // Aktuelles toggeln
        const willOpen = !card.classList.contains('open');
        if(willOpen) {
            card.classList.add('open');
            openRecipeId = id; // Merken!
        } else {
            card.classList.remove('open');
            openRecipeId = null; // Vergessen
        }
    }

    window.addRecipe = async function() {
        const input = document.getElementById('newRecipeName');
        const name = input.value.trim();
        if(!name) return;
        await addDoc(collection(db, "recipes"), { name: name, ingredients: [], createdAt: serverTimestamp() });
        input.value = '';
    }

    window.deleteRecipe = async function(id) {
        if(confirm("Rezept wirklich l√∂schen?")) await deleteDoc(doc(db, "recipes", id));
    }

    window.addIngredient = async function(recipeId, val) {
        if(!val || !val.trim()) return;
        await updateDoc(doc(db, "recipes", recipeId), { ingredients: arrayUnion(val.trim()) });
        // Wir verlassen uns auf das Re-Render, input clearen passiert automatisch durch rebuild
    }
    
    window.addIngredientTrigger = function(recipeId) {
        const input = document.querySelector(`#recipe-${recipeId} .recipe-ing-input`);
        addIngredient(recipeId, input.value);
    }

    window.deleteIngredient = async function(recipeId, name) {
        await updateDoc(doc(db, "recipes", recipeId), { ingredients: arrayRemove(name) });
    }

    // --- REZEPT TRANSFER ---
    window.openRecipeAddPanel = async function(recipeId) {
        const docRef = doc(db, "recipes", recipeId);
        const snap = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(m => m.getDoc(docRef));
        if(!snap.exists()) return;
        
        const ingredients = snap.data().ingredients || [];
        if(ingredients.length === 0) { alert("Rezept hat keine Zutaten!"); return; }

        transferIngredients = []; 
        const container = document.getElementById('recipeAddContainer');
        container.innerHTML = '';
        
        ingredients.forEach(ing => {
            transferIngredients.push(ing);
            const row = document.createElement('div');
            row.className = 'fav-row selected';
            row.innerHTML = `<span>${ing}</span> <span class="check-icon">‚úî</span>`;
            row.onclick = function() {
                if(row.classList.contains('selected')) {
                    row.classList.remove('selected');
                    transferIngredients = transferIngredients.filter(x => x !== ing);
                } else {
                    row.classList.add('selected');
                    transferIngredients.push(ing);
                }
            };
            container.appendChild(row);
        });
        document.getElementById('favOverlay').classList.add('visible');
        document.getElementById('recipeAddPanel').classList.add('visible');
    }

    window.confirmAddRecipe = async function() {
        if(transferIngredients.length === 0) { closePanels(); return; }
        const batch = writeBatch(db);
        let count = 0;
        transferIngredients.forEach((name, idx) => {
            const exists = localItems.some(item => item.name.toLowerCase() === name.toLowerCase());
            if(!exists) {
                const ref = doc(collection(db, "shopping_items"));
                batch.set(ref, {
                    name: name, qty: "", fav: favorites.includes(name), listName: currentList,
                    createdAt: serverTimestamp(), sortOrder: Date.now() + idx
                });
                count++;
            }
        });
        if(count > 0) await batch.commit();
        closePanels();
        switchView('shopping', document.querySelector('.bottom-nav .nav-item:first-child'));
    }

    // --- FAVORITEN ---
    function subscribeToFavorites() {
        const q = query(collection(db, "favorites"), orderBy("name", "asc"));
        favsUnsubscribe = onSnapshot(q, (snapshot) => {
            favorites = [];
            snapshot.forEach(doc => favorites.push(doc.data().name));
        });
    }

    window.openFavPanel = function(mode, recipeId = null) {
        targetMode = mode; targetRecipeId = recipeId;
        const overlay = document.getElementById('favOverlay');
        const panel = document.getElementById('favPanel');
        const container = document.getElementById('favListContainer');
        const btn = document.getElementById('btnConfirmFavs');
        
        selectedFavs = [];
        btn.innerText = "Hinzuf√ºgen";
        btn.classList.remove('ready');
        container.innerHTML = '';

        if(favorites.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#777;">Keine Favoriten vorhanden.</div>';
        } else {
            const uniqueFavs = [...new Set(favorites)];
            uniqueFavs.forEach(fav => {
                const div = document.createElement('div');
                div.className = 'fav-row';
                div.innerHTML = `<span>${fav}</span> <span class="check-icon">‚úî</span>`;
                div.onclick = function() { toggleFavSelection(this, fav); };
                container.appendChild(div);
            });
        }
        overlay.classList.add('visible');
        panel.classList.add('visible');
    }

    window.closePanels = function() {
        document.querySelectorAll('.panel-overlay').forEach(e => e.classList.remove('visible'));
        document.querySelectorAll('.fav-panel').forEach(e => e.classList.remove('visible'));
    }

    window.toggleFavSelection = function(element, name) {
        if(selectedFavs.includes(name)) {
            selectedFavs = selectedFavs.filter(f => f !== name);
            element.classList.remove('selected');
        } else {
            selectedFavs.push(name);
            element.classList.add('selected');
        }
        const btn = document.getElementById('btnConfirmFavs');
        if(selectedFavs.length > 0) {
            btn.classList.add('ready');
            btn.innerText = `${selectedFavs.length} Hinzuf√ºgen`;
        } else {
            btn.classList.remove('ready');
            btn.innerText = "Hinzuf√ºgen";
        }
    }

    window.addSelectedFavs = async function() {
        if(selectedFavs.length === 0) return;
        
        if (targetMode === 'list') {
            const batch = writeBatch(db);
            let itemsAdded = 0;
            selectedFavs.forEach((name, idx) => {
                const exists = localItems.some(item => item.name.toLowerCase() === name.toLowerCase());
                if (!exists) {
                    const ref = doc(collection(db, "shopping_items"));
                    batch.set(ref, {
                        name: name, qty: "", fav: true, listName: currentList,
                        createdAt: serverTimestamp(), sortOrder: Date.now() + idx
                    });
                    itemsAdded++;
                }
            });
            if (itemsAdded > 0) await batch.commit();
        
        } else if (targetMode === 'recipe' && targetRecipeId) {
            const ref = doc(db, "recipes", targetRecipeId);
            await updateDoc(ref, { ingredients: arrayUnion(...selectedFavs) });
        }
        closePanels();
    }

    // --- STANDARD LOGIK ---

    function subscribeToAllLists() {
        const q = query(collection(db, "shopping_lists"), orderBy("createdAt", "asc"));
        listUnsubscribe = onSnapshot(q, (snapshot) => {
            const select = document.getElementById('listSelect');
            select.innerHTML = '';
            let foundCurrent = false;
            snapshot.forEach(doc => {
                const data = doc.data();
                const option = document.createElement('option');
                option.value = data.name;
                option.innerText = data.name;
                select.appendChild(option);
                if (data.name === currentList) foundCurrent = true;
            });
            if (!foundCurrent && snapshot.docs.length > 0) currentList = snapshot.docs[0].data().name;
            else if (snapshot.docs.length === 0) select.innerHTML = '<option>Keine Liste</option>';
            select.value = currentList;
            updateTitle();
            subscribeToItems();
        });
    }

    window.createNewList = async function() {
        const name = prompt("Name der neuen Liste:");
        if (name && name.trim()) {
            const cleanName = name.trim();
            await addDoc(collection(db, "shopping_lists"), { name: cleanName, createdAt: serverTimestamp() });
            currentList = cleanName;
            localStorage.setItem('lastActiveList', currentList);
        }
    }

    window.deleteCurrentList = async function() {
        if (!confirm(`Liste "${currentList}" wirklich l√∂schen?`)) return;
        const listQuery = query(collection(db, "shopping_lists"), where("name", "==", currentList));
        const listSnap = await getDocs(listQuery);
        listSnap.forEach(async (d) => await deleteDoc(doc(db, "shopping_lists", d.id)));
        const itemsQuery = query(collection(db, "shopping_items"), where("listName", "==", currentList));
        const itemsSnap = await getDocs(itemsQuery);
        const batch = writeBatch(db);
        itemsSnap.forEach((d) => batch.delete(d.ref));
        await batch.commit();
    }

    window.switchList = function() {
        currentList = document.getElementById('listSelect').value;
        localStorage.setItem('lastActiveList', currentList);
        updateTitle();
        subscribeToItems();
    }

    function updateTitle() { document.getElementById('currentTitle').innerText = "Aktuell: " + currentList; }

    function subscribeToItems() {
        if (itemsUnsubscribe) itemsUnsubscribe();
        const listRef = collection(db, "shopping_items");
        const q = query(listRef, where("listName", "==", currentList), orderBy("sortOrder", "asc"));
        itemsUnsubscribe = onSnapshot(q, (snapshot) => {
            localItems = [];
            const listContainer = document.getElementById('shoppingList');
            listContainer.innerHTML = '';
            snapshot.forEach((doc) => {
                let data = doc.data();
                if (!data.sortOrder && data.createdAt) data.sortOrder = data.createdAt.seconds;
                localItems.push({ id: doc.id, ...data });
            });
            renderList(localItems);
        });
    }

    function renderList(items) {
        const listContainer = document.getElementById('shoppingList');
        if(items.length === 0) listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#555;">Liste ist leer</div>';
        
        items.forEach((item, index) => {
            const row = document.createElement('div');
            row.className = 'item-row';
            
            row.innerHTML = `
                <button class="btn-star ${item.fav ? 'is-fav' : ''}" onclick="toggleFavCloud('${item.id}', ${item.fav}, '${item.name}')">
                    ${item.fav ? '‚òÖ' : '‚òÜ'}
                </button>
                <div class="qty-display">${item.qty || ''}</div>
                <div class="name-text">${item.name}</div>
                
                <input type="text" class="qty-input" placeholder="Stk" value="${item.qty || ''}" 
                       onchange="updateItemQty('${item.id}', this.value)">
                <button class="btn-delete" onclick="deleteItem('${item.id}')">√ó</button>

                <div class="sort-controls">
                    <button class="btn-arrow extreme" onclick="moveItemToTop(${index})" title="Ganz nach oben">‚§í</button>
                    <button class="btn-arrow" onclick="moveItem(${index}, -1)">‚ñ≤</button>
                    <button class="btn-arrow" onclick="moveItem(${index}, 1)">‚ñº</button>
                    <button class="btn-arrow extreme" onclick="moveItemToBottom(${index})" title="Ganz nach unten">‚§ì</button>
                </div>
            `;
            listContainer.appendChild(row);
        });
    }

    window.addItem = async function(nameOverride) {
        let name = nameOverride;
        if (!name) {
            const input = document.getElementById('newItemName');
            name = input.value.trim();
            input.value = '';
        }
        if (!name) return;
        
        const exists = localItems.some(item => item.name.toLowerCase() === name.toLowerCase());
        if (exists) { alert(`"${name}" steht schon auf der Liste!`); return; }
        
        const isFav = favorites.includes(name);
        await addDoc(collection(db, "shopping_items"), {
            name: name, qty: "", fav: isFav, listName: currentList,
            createdAt: serverTimestamp(), sortOrder: Date.now()
        });
    }

    window.deleteItem = async function(id) { await deleteDoc(doc(db, "shopping_items", id)); }
    window.updateItemQty = async function(id, newQty) { await updateDoc(doc(db, "shopping_items", id), { qty: newQty }); }

    window.toggleFavCloud = async function(id, currentStatus, name) {
        const newStatus = !currentStatus;
        await updateDoc(doc(db, "shopping_items", id), { fav: newStatus });
        if (newStatus) {
            if(!favorites.includes(name)) await addDoc(collection(db, "favorites"), { name: name });
        } else {
            const q = query(collection(db, "favorites"), where("name", "==", name));
            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            snapshot.forEach(doc => { batch.delete(doc.ref); });
            await batch.commit();
        }
    }

    window.toggleSortMode = function() {
        isSortMode = !isSortMode;
        document.body.classList.toggle('sorting-active', isSortMode);
        document.querySelector('.btn-header.sort').classList.toggle('active', isSortMode);
    }
    window.moveItem = function(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= localItems.length) return;
        saveNewOrder(index, newIndex);
    }
    window.moveItemToTop = function(index) { if (index === 0) return; saveNewOrder(index, 0); }
    window.moveItemToBottom = function(index) { if (index === localItems.length - 1) return; saveNewOrder(index, localItems.length - 1); }
    async function saveNewOrder(from, to) {
        const movedItem = localItems.splice(from, 1)[0];
        localItems.splice(to, 0, movedItem);
        renderList(localItems);
        const batch = writeBatch(db);
        localItems.forEach((item, idx) => {
            const ref = doc(db, "shopping_items", item.id);
            batch.update(ref, { sortOrder: idx }); 
        });
        await batch.commit();
    }

    subscribeToAllLists();
    subscribeToFavorites();
    subscribeToRecipes();

</script>
</body>
</html>